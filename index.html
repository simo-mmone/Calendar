<html>

<head>
    <meta name="viewport" content="width=device-width">
</head>

<body>
    <div id="calendar-month">
        <div id="calendar-month-prev">←</div>
        <div id="calendar-month-name"></div>
        <div id="calendar-month-next">→</div>
    </div>
    <div id="calendar"></div>

    <style>
        #calendar-month {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        #calendar-month-prev,
        #calendar-month-next {
            cursor: pointer;
        }

        .week {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .week.mobile {
            display: none;
        }

        .weekday {
            width: calc(100% / 7);
            min-height: 90px;
            border: 1px solid black;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: start;
            padding: 10px;
        }

        .week .day .number{
            font-size: small;
            color: #212121;
        }

        .week .day .offer .link{
            margin: 10px;
            display: flex;
            flex-direction: column;
            text-decoration: none;
            gap: 10px;
        }

        .week .day .offer .link .name {
            font-weight: bold;
            color: #212121;
        }

        .week .day .offer .info {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 20px;
            font-size: small;
            color: #424242;
        }

        @media screen and (max-width: 1040px) {
            .weekday {
                /* border: none; */
                min-height: 50px;
                justify-content: center;
                padding: 0;
            }

            .offer {
                display: none;
            }

            .week.desktop {
                display: none;
            }

            .week.mobile {
                display: flex;
            }

            .weekday.has-offer {
                background-color: greenyellow;
            }
        }
    </style>

    <script>

        const configs = {
            'booking': 'https://volpe.abs-one.com/metis',
            'host': 'https://volpe.abs-one.com',
            'language': 'it',
            'structureId': 6,
            'portalId': 1,
            'offerId': 1294,
            'offerName': 'Blue Days'
        };

        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
            return result;
        }

        function daysInThisMonth(now = new Date()) {
            return new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        }

        function increaseMonth(month, year) {
            if (month === 11) {
                month = 0;
                year++;
            } else {
                month++;
            }
            return [month, year];
        }

        function decreaseMonth(month, year) {
            if (month === 0) {
                month = 11;
                year--;
            } else {
                month--;
            }
            return [month, year];
        }

        function indexToWeekday(index, weekdays) {
            return (index + 1) % 7;
        }

        function updateShownMonth(month, year) {
            let htmlMonthName = document.getElementById("calendar-month-name");
            htmlMonthName.innerHTML = `${month + 1}/${year}`;
        }        

        async function getAllOffers(month, year, offerId) {

            let results = [];

            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);
            const now = Date.now();

            // Create a new Headers object and set multiple headers
            const headers = new Headers();
            headers.append('StructureId', configs.structureId);
            headers.append('PortalId', configs.portalId);
            headers.append('offer', offerId);
            // headers.append('UserLanguageCode', 'it');

            // Create the fetch options
            const requestOptions = {
            method: 'GET',
            headers: headers,
            };

            // Make the fetch GET request with multiple headers
            const resp = await fetch(`${configs.host}/RESTfulAPI/booking/offers`, requestOptions);
            if (!resp.ok) {
                console.log(`HTTP error! Status: ${resp.status}`);
                return [];
            }
            const data = await resp.json();
            return JSON.parse(data);
        }

        function changeMonth(month, year, direction, offers = [], offerToShow = 0, offerName = "") {
            if (direction === "next") {
                [new_month, new_year] = increaseMonth(month, year, offers);
            } else if (direction === "prev") {
                [new_month, new_year] = decreaseMonth(month, year, offers);
            }
            updateShownMonth(new_month, new_year);
            let htmlCalendar = document.getElementById("calendar");
            htmlCalendar.innerHTML = printCalendar(new_month, new_year);

            showOffers(new_month, new_year, offers, offerToShow, offerName);

            return [new_month, new_year];
        }

        function printWeekdays(weekdays) {
            let html = "";
            // start from monday
            let weekdaysindex = 1;
            html += `<div class="week desktop">`;
            for (let i = 0; i < 7; i++) {
                html += `
                    <div class="weekday name">
                        ${weekdays[weekdaysindex++ % 7]}
                    </div>
                `;
            }
            html += `</div>`;
            weekdaysindex = 1;
            html += `<div class="week mobile">`;
            for (let i = 0; i < 7; i++) {
                html += `
                    <div class="weekday name">
                        ${weekdays[weekdaysindex++ % 7].charAt(0)}
                    </div>
                `;
            }
            html += `</div>`;
            return html;
        }

        function showOffers(month, year, offers, requestedOffer, offerName) {
            // console.log("showOffers", month, year, offers);
            const dateToCheck = new Date(year, month); // Month is zero-based
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                dateToCheck.setDate(day);

                //format date as YYYY-MM-DD
                const date = dateToCheck.toISOString().slice(0, 10);
                // console.log("date", date);
                if (offers[date]){
                    const offerDate = offers[date];
                    const htmlDay = document.getElementsByClassName(`day-${day}`);
                    htmlDay[0].classList.add("has-offer");

                    let minStay = 0;
                    let minPrice = 0;
                    for (let offerRoom in offerDate) {
                        minStay = offerDate[offerRoom].min[0];
                        for (let price in offerDate[offerRoom].prices) {
                            // console.log("price", offerDate[offerRoom].prices[price]);
                            minPrice = offerDate[offerRoom].prices[price];
                            break;
                        }
                        break;
                    }
                    // console.log("offerDate", minStay);
                    $hrefLink = '';

                    // htmlDay[0].innerHTML += `offer`;
                    htmlDay[0].innerHTML += `
                        <div class="offer">
                            <a target="_blank" class="link" ${$hrefLink}">
                                <div class="price">
                                    ${minPrice} €
                                </div>
                                <div class="minstay">
                                    min. ${minStay} nights
                                </div>
                                <div class="name">
                                    ${offerName}
                                </div>
                            </a>
                        </div>
                    `;
                }

                // const activeObjects = offers.filter(obj => {
                //     const startDate = new Date(obj.validityStart);
                //     const endDate = new Date(obj.validityEnd);

                //     // TODO: check if offer is visible today?

                //     // Check if dateToCheck is between startDate and endDate
                //     return startDate <= dateToCheck && dateToCheck <= endDate && obj.id == requestedOffer;
                // });

                // if (activeObjects.length > 0) {
                //     for (let i = 0; i < activeObjects.length; i++) {
                //         const offer = activeObjects[i];
                //         const shownOfferName = offerName != null ? offerName : offer.name;
                //         const offerMinStay = offer.minstay;
                //         const htmlDay = document.getElementsByClassName(`day-${day}`);
                //         const isDateInPast = dateToCheck < new Date();

                //         const shownDay = day;
                //         const shownDayWithZero = shownDay < 10 ? "0" + shownDay : shownDay;
                //         const shownMonth = month + 1;
                //         const shownMonthWithZero = shownMonth < 10 ? "0" + shownMonth : shownMonth;

                //         const daysToAdd = offerMinStay ? parseInt(offerMinStay) : 1;
                //         const nextDay = (day + daysToAdd) % daysInMonth;
                //         const hasGoneToNextMonth = nextDay != (day + daysToAdd);
                //         const shownNextDayWithZero = nextDay < 10 ? "0" + nextDay : nextDay;
                //         const nextDayMonth = hasGoneToNextMonth ? (shownMonth + 1) % 12 : shownMonth;
                //         const shownNextDayMonthWithZero = nextDayMonth < 10 ? "0" + nextDayMonth : nextDayMonth;
                //         const nextDayYear = nextDayMonth < month ? year + 1 : year;

                //         const nextDayWithZero = nextDay < 10 ? "0" + nextDay : nextDay;
                //         const nextDayMonthWithZero = nextDayMonth < 10 ? "0" + nextDayMonth : nextDayMonth;

                //         //compose link
                //         //https://volpe.abs-one.com/metis/indexabs.php?checkin=20-03-2023&checkout=21-03-2023&stid=6&lg=it&booking_type=R&step2=1&offerid=1294&hdr=1&ftr=1&style=https%3A%2F%2Fssl.marcovolpe.com%2Fcss%2Fhotel-atlantic.com-it.css&showmode=minisite&bform%5BreqRooms%5D%5B1%5D%5Badults%5D=2&bform%5BreqRooms%5D%5B1%5D%5Bchild%5D=0&numRooms=1
                //         const dateCheckin = `${shownDayWithZero}-${shownMonthWithZero}-${year}`;
                //         const dateCheckout = `${shownNextDayWithZero}-${shownNextDayMonthWithZero}-${nextDayYear}`;
                //         const link = `${configs.booking}/indexabs.php?checkin=${dateCheckin}&checkout=${dateCheckout}&stid=${configs.structureId}&lg=${configs.language}&booking_type=R&step2=1&offerid=${offer.id}&hdr=1&ftr=1&style=https%3A%2F%2Fssl.marcovolpe.com%2Fcss%2Fhotel-atlantic.com-it.css&showmode=minisite&bform%5BreqRooms%5D%5B1%5D%5Badults%5D=2&bform%5BreqRooms%5D%5B1%5D%5Bchild%5D=0&numRooms=1&mobileoffertype=M`;

                //         $hrefLink = isDateInPast ? '' : `href="${link}"`;

                //         htmlDay[0].classList.add("has-offer");
                //         htmlDay[0].innerHTML += `
                //             <div class="offer">
                //                 <a target="_blank" class="link" ${$hrefLink}">
                //                     <div class="price">
                //                         ${offer.price_from} €
                //                     </div>
                //                     <div class="minstay">
                //                         min. ${offerMinStay} 
                //                     </div>
                //                     <div class="name">
                //                         ${shownOfferName}
                //                     </div>
                //                 </a>
                //             </div>
                //         `;
                //     }
                // }
            }
        }

        function printCalendar(month, year) {
            let html = "";
            let daysInMonth = daysInThisMonth(new Date(year, month));
            let weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            let dayIndex = 0;
            const dateToCheck = new Date(year, month - 1);

            html += printWeekdays(weekdays);

            // print days week by week
            html += `<div class="week">`;
            for (let i = 0; (dayIndex < daysInMonth || i % 7 != 0); i++) {
                if (i % 7 === 0 && i !== 0) {
                    html += `</div>`;
                    html += `<div class="week">`;
                }

                let weekday = new Date(year, month, (dayIndex + 1)).getDay();
                let printDay = (weekday == indexToWeekday(i, weekdays) && dayIndex < daysInMonth);
                let newDayIndex = printDay ? dayIndex + 1 : dayIndex;

                html += `<div class="weekday ${printDay ? 'day day-' + newDayIndex : ''}">`;
                // console.log(dayIndex, weekday, indexToWeekday(i, weekdays));
                if (printDay) {
                    html += `
                        <div class='number'>
                            ${++dayIndex}
                        </div>
                    `;
                }
                html += `</div>`;


            }
            html += `</div>`;
            return html;
        }

        const offerToShow = configs.offerId;
        const offerName = configs.offerName;
        // init month and year as current month and year
        let month = new Date().getMonth();
        let year = new Date().getFullYear();
        let offers = [];
        updateShownMonth(month, year);

        // show calendar
        let htmlCalendar = document.getElementById("calendar");
        htmlCalendar.innerHTML = printCalendar(month, year);
        getAllOffers(month, year, offerToShow).then(data => {
            offers = data;
            // console.log(offers);
            showOffers(month, year, data, offerToShow, offerName);
        });

        // add event listeners
        let htmlPrev = document.getElementById("calendar-month-prev");
        htmlPrev.addEventListener("click", () => [month, year] = changeMonth(month, year, "prev", offers, offerToShow, offerName));
        let htmlNext = document.getElementById("calendar-month-next");
        htmlNext.addEventListener("click", () => [month, year] = changeMonth(month, year, "next", offers, offerToShow, offerName));


    </script>
</body>

</html>